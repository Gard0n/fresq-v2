<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0e1a">
  <title>FRESQ V2 - Statistiques</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
      color: #e0e6ed;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding: 40px 20px;
      background: rgba(26, 31, 46, 0.6);
      border-radius: 16px;
      border: 1px solid #2a3f5f;
    }

    header h1 {
      font-size: 48px;
      background: linear-gradient(135deg, #6FE6FF 0%, #2aa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    header p {
      color: #888;
      font-size: 18px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: rgba(26, 31, 46, 0.8);
      border: 1px solid #2a3f5f;
      border-radius: 12px;
      padding: 30px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(111, 230, 255, 0.2);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .stat-card .value {
      font-size: 48px;
      font-weight: 700;
      color: #6FE6FF;
      margin-bottom: 8px;
    }

    .stat-card .sub {
      color: #666;
      font-size: 14px;
    }

    .progress-section {
      background: rgba(26, 31, 46, 0.8);
      border: 1px solid #2a3f5f;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .progress-section h2 {
      font-size: 24px;
      color: #6FE6FF;
      margin-bottom: 20px;
    }

    .progress-bar {
      height: 40px;
      background: rgba(10, 14, 26, 0.8);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2a4 0%, #3d6 100%);
      transition: width 1s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 15px;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
    }

    .activity-chart {
      background: rgba(26, 31, 46, 0.8);
      border: 1px solid #2a3f5f;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .activity-chart h2 {
      font-size: 24px;
      color: #6FE6FF;
      margin-bottom: 20px;
    }

    .chart-container {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 200px;
      gap: 8px;
      padding: 20px 0;
    }

    .chart-bar {
      flex: 1;
      background: linear-gradient(0deg, #2a4 0%, #3d6 100%);
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: all 0.3s ease;
      min-height: 10px;
    }

    .chart-bar:hover {
      background: linear-gradient(0deg, #3d6 0%, #4e8 100%);
      transform: scaleY(1.05);
    }

    .chart-bar .label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #666;
      white-space: nowrap;
    }

    .chart-bar .value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: #6FE6FF;
      font-weight: 600;
    }

    .leaderboard {
      background: rgba(26, 31, 46, 0.8);
      border: 1px solid #2a3f5f;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .leaderboard h2 {
      font-size: 24px;
      color: #6FE6FF;
      margin-bottom: 20px;
    }

    .leaderboard-list {
      list-style: none;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(10, 14, 26, 0.5);
      border-radius: 8px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .leaderboard-item:hover {
      background: rgba(42, 63, 95, 0.3);
      transform: translateX(4px);
    }

    .leaderboard-rank {
      font-size: 24px;
      font-weight: 700;
      color: #6FE6FF;
      min-width: 40px;
    }

    .leaderboard-rank.gold { color: #FFD700; }
    .leaderboard-rank.silver { color: #C0C0C0; }
    .leaderboard-rank.bronze { color: #CD7F32; }

    .leaderboard-user {
      flex: 1;
      margin-left: 16px;
    }

    .leaderboard-user .email {
      font-size: 16px;
      color: #e0e6ed;
      margin-bottom: 4px;
    }

    .leaderboard-user .meta {
      font-size: 13px;
      color: #666;
    }

    .leaderboard-score {
      font-size: 20px;
      font-weight: 600;
      color: #2a4;
    }

    .cta-section {
      text-align: center;
      padding: 40px;
      background: rgba(26, 31, 46, 0.8);
      border: 1px solid #2a3f5f;
      border-radius: 12px;
    }

    .cta-section h2 {
      font-size: 32px;
      color: #6FE6FF;
      margin-bottom: 16px;
    }

    .cta-section p {
      color: #888;
      font-size: 18px;
      margin-bottom: 24px;
    }

    .btn {
      display: inline-block;
      padding: 16px 48px;
      background: linear-gradient(135deg, #2a4 0%, #1a3 100%);
      border: 1px solid #3b5;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(42, 170, 68, 0.4);
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #6FE6FF;
      font-size: 18px;
    }

    footer {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 32px;
      }

      .stat-card .value {
        font-size: 36px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üé® FRESQ V2</h1>
      <p>Fresque Collaborative - Statistiques en Temps R√©el</p>
    </header>

    <div id="loading" class="loading">
      Chargement des statistiques...
    </div>

    <div id="content" style="display: none;">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Utilisateurs</h3>
          <div class="value" id="stat-users">-</div>
          <div class="sub">Contributeurs actifs</div>
        </div>

        <div class="stat-card">
          <h3>Codes G√©n√©r√©s</h3>
          <div class="value" id="stat-codes">-</div>
          <div class="sub"><span id="stat-claimed">-</span> r√©clam√©s</div>
        </div>

        <div class="stat-card">
          <h3>Cases Peintes</h3>
          <div class="value" id="stat-painted">-</div>
          <div class="sub"><span id="stat-percent">0%</span> de la grille</div>
        </div>

        <div class="stat-card">
          <h3>Derni√®res 24h</h3>
          <div class="value" id="stat-24h">-</div>
          <div class="sub">Nouvelles contributions</div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-section">
        <h2>üìà Progression de la Fresque</h2>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill">0%</div>
        </div>
        <p style="text-align: center; margin-top: 16px; color: #888;">
          <span id="remaining-cells">40,000</span> cases restantes sur 40,000
        </p>
      </div>

      <!-- Activity Chart -->
      <div class="activity-chart">
        <h2>üìä Activit√© des 7 Derniers Jours</h2>
        <div class="chart-container" id="activity-chart">
          <!-- Filled by JavaScript -->
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="leaderboard">
        <h2>üèÜ Top Contributeurs</h2>
        <ul class="leaderboard-list" id="leaderboard">
          <!-- Filled by JavaScript -->
        </ul>
      </div>

      <!-- CTA -->
      <div class="cta-section">
        <h2>Rejoins l'Aventure !</h2>
        <p>Participe √† la cr√©ation de cette fresque collaborative g√©ante</p>
        <a href="/" class="btn">üé® Commencer √† Peindre</a>
      </div>
    </div>

    <footer>
      <p>FRESQ V2 - Une exp√©rience collaborative par la communaut√©</p>
      <p style="margin-top: 8px; opacity: 0.6;">Stats mises √† jour en temps r√©el</p>
    </footer>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Connect to WebSocket for real-time updates
    const socket = io();

    // Elements
    const loading = document.getElementById('loading');
    const content = document.getElementById('content');
    const statUsers = document.getElementById('stat-users');
    const statCodes = document.getElementById('stat-codes');
    const statClaimed = document.getElementById('stat-claimed');
    const statPainted = document.getElementById('stat-painted');
    const statPercent = document.getElementById('stat-percent');
    const stat24h = document.getElementById('stat-24h');
    const progressFill = document.getElementById('progress-fill');
    const remainingCells = document.getElementById('remaining-cells');
    const activityChart = document.getElementById('activity-chart');
    const leaderboard = document.getElementById('leaderboard');

    // Format numbers with commas
    function formatNumber(num) {
      return num.toLocaleString('fr-FR');
    }

    // Load statistics
    async function loadStats() {
      try {
        // Get basic stats
        const statsRes = await fetch('/api/admin/stats');
        const stats = await statsRes.json();

        // Update stats cards
        statUsers.textContent = formatNumber(stats.total_users);
        statCodes.textContent = formatNumber(stats.total_codes);
        statClaimed.textContent = formatNumber(stats.claimed_codes);
        statPainted.textContent = formatNumber(stats.painted_cells);
        statPercent.textContent = stats.percent_painted + '%';
        stat24h.textContent = formatNumber(stats.painted_24h);

        // Update progress bar
        const percent = parseFloat(stats.percent_painted);
        progressFill.style.width = percent + '%';
        progressFill.textContent = percent.toFixed(2) + '%';
        remainingCells.textContent = formatNumber(40000 - stats.painted_cells);

        // Get detailed stats
        const detailedRes = await fetch('/api/admin/stats/detailed');
        const detailed = await detailedRes.json();

        // Render activity chart
        renderActivityChart(detailed.activityByDay || []);

        // Get leaderboard (we'll need to create this endpoint)
        await loadLeaderboard();

        // Show content
        loading.style.display = 'none';
        content.style.display = 'block';
      } catch (err) {
        console.error('Error loading stats:', err);
        loading.textContent = 'Erreur de chargement des statistiques';
      }
    }

    function renderActivityChart(activityData) {
      activityChart.innerHTML = '';

      if (!activityData || activityData.length === 0) {
        activityChart.innerHTML = '<p style="text-align: center; color: #666;">Aucune donn√©e disponible</p>';
        return;
      }

      // Sort by date (oldest first for chart)
      const sorted = activityData.sort((a, b) => new Date(a.date) - new Date(b.date));

      // Get max value for scaling
      const maxCount = Math.max(...sorted.map(d => d.count), 1);

      sorted.forEach(day => {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        const height = (day.count / maxCount) * 100;
        bar.style.height = height + '%';

        const date = new Date(day.date);
        const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });

        bar.innerHTML = `
          <div class="value">${day.count}</div>
          <div class="label">${dayName}</div>
        `;

        activityChart.appendChild(bar);
      });
    }

    async function loadLeaderboard() {
      try {
        const res = await fetch('/api/leaderboard?limit=10');
        const data = await res.json();

        if (!data.ok || !data.leaderboard || data.leaderboard.length === 0) {
          leaderboard.innerHTML = '<p style="text-align: center; color: #666;">Aucun contributeur pour le moment</p>';
          return;
        }

        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const rankClasses = ['gold', 'silver', 'bronze'];

        leaderboard.innerHTML = data.leaderboard.map((user, index) => {
          const rank = index + 1;
          const medal = medals[index] || '';
          const rankClass = rankClasses[index] || '';

          return `
            <li class="leaderboard-item">
              <div class="leaderboard-rank ${rankClass}">${medal || '#' + rank}</div>
              <div class="leaderboard-user">
                <div class="email">${user.email}</div>
                <div class="meta">Top contributeur</div>
              </div>
              <div class="leaderboard-score">${user.painted_count} cell${user.painted_count > 1 ? 's' : ''}</div>
            </li>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading leaderboard:', err);
        leaderboard.innerHTML = '<p style="text-align: center; color: #666;">Erreur de chargement</p>';
      }
    }

    // Real-time updates via WebSocket
    socket.on('cell_update', () => {
      // Reload stats when someone paints
      setTimeout(loadStats, 1000);
    });

    // Load stats on page load
    loadStats();

    // Refresh every 30 seconds
    setInterval(loadStats, 30000);
  </script>
</body>
</html>
